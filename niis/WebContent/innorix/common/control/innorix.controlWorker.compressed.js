/*! INNORIX - v8.0.0 - 2016-11-18
* http://www.innorix.com
* Copyright (c) 2016 INNORIX
* Licensed MIT http://opensource.org/licenses/MIT */
"use strict";function formDataPolyfill(a){function b(){if(!(this instanceof b))return new b;this.boundary="------RWWorkerFormDataBoundary"+Math.random().toString(36);var a=this.data=[];this.__append=function(b){var c,d=0;if("string"==typeof b)for(c=b.length;d<c;++d)a.push(255&b.charCodeAt(d));else if(b&&b.byteLength){"byteOffset"in b||(b=new Uint8Array(b));for(c=b.byteLength;d<c;++d)a.push(255&b[d])}}}if(!a.FormData){a.FormData=b;var c=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(a){return a instanceof b&&(a.__endedMultipart||a.__append("--"+a.boundary+"--\r\n"),a.__endedMultipart=!0,this.setRequestHeader("Content-Type","multipart/form-data; boundary="+a.boundary),a=new Uint8Array(a.data)),c.call(this,a)},b.prototype.append=function(a,b,c){if(this.__endedMultipart&&(this.data.length-=this.boundary.length+6,this.__endedMultipart=!1),arguments.length<2)throw new SyntaxError("Not enough arguments");var d="--"+this.boundary+'\r\nContent-Disposition: form-data; name="'+a+'"';return"[object File]"===Object.prototype.toString.call(b)||"[object Blob]"===Object.prototype.toString.call(b)?this.append(a,new Uint8Array((new FileReaderSync).readAsArrayBuffer(b)),c||b.name):("number"==typeof b.byteLength?(d+='; filename="'+(c||"blob").replace(/"/g,"%22")+'"\r\n',d+="Content-Type: application/octet-stream\r\n\r\n",this.__append(d),this.__append(b),d="\r\n"):d+="\r\n\r\n"+b+"\r\n",void this.__append(d))}}}function generateUUID(){var a,b;return a=(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==b?c:7&c|8).toString(16)})}function getFileName(a){var b,c;return b=a.replace(/\\/gi,"/"),c=b.substring(b.lastIndexOf("/")+1)}function getFileExt(a){var b,c;return b=a.replace(/\\/gi,"/"),c=b.substring(b.lastIndexOf(".")+1)}function checkExt(a,b){var c,d,e;for(c=getFileExt(a),d=0,e=b.length;d<e;d++)if(b[d]===c)return!0;return!1}function getFormData(a){var b,c;b=new FormData;for(c in a)a.hasOwnProperty(c)&&b.append(c,a[c]);return b}function postMsg(a,b,c){self.postMessage({type:a,controlId:c||controlId,value:b})}function createFileInfo(a){controlId=a,fileInfo={},fileInfo.fileIds=[],fileInfo.files={},fileInfo.totalFileSize=0}function refreshUi(){var a=fileInfo;postMsg("refreshUi",{totalFileInfo:a})}function checkFileLimitation(a,b){var c,d,e;return c=fileInfo,d=c.fileIds.length,e=c.totalFileSize,d+1>b.maxFileCount?"overFileCount":a>b.maxFileSize?"overFileSize":e+a>b.maxTotalSize?"overTotalSize":void 0}function checkFileIntegrity(a,b){var c,d,e,f;if(c=b.limitExtension,c&&checkExt(a,c))return"cannotFileExt|"+getFileExt(a);if(d=b.allowExtension,d&&!checkExt(a,d))return"cannotFileExt|"+getFileExt(a);if(!b.addDuplicateFile){e=fileInfo.files;for(f in e)if(a===e[f].filePath)return"fileDuplicate"}}function addFile(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;for(addedFiles?addedFiles.length=0:addedFiles=[],errorFiles?errorFiles.length=0:errorFiles=[],l=fileInfo,c=0,d=a.length;c<d&&(m=(c+"").length,n=(c-1+"").length,m-n>0&&postMsg("setAniCountTxt",{aniTxtLen:m}),e=a[c],f=e.fileSize,!(k=checkFileLimitation(f,b)));c++){if(g=e.filePath,h=getFileName(g),i=generateUUID(),j={rowId:i,size:f,name:h,filePath:g,localPath:g,dropID:e.dropID||null,basePath:e.basePath||null,uploadUrl:e.uploadURL?e.uploadURL:b.uploadUrl},k=checkFileIntegrity(g,b)){if(b.continueAddFile){errorFiles.push(j),k=void 0;continue}break}l.files[i]=j,l.totalFileSize+=f,l.fileIds.push(i),addedFiles.push(j)}postMsg("addFile",{errMsg:k,addedFiles:addedFiles,errorFiles:errorFiles,totalFileInfo:l})}function removeAllFiles(){var a=fileInfo;a.fileIds.length=0,a.files={},a.totalFileSize=0,postMsg("removeAllFiles",{totalFileInfo:a})}function prepareUpload(a,b){var c,d,e,f,g,h,i,j;for(c=fileInfo,d=c.fileIds,e=c.files,h=[],f=0,g=d.length;f<g;f++)h.push(e[d[f]]);h.length>0&&(i={},i[controlId]=h,j=JSON.stringify(i)),postMsg("prepareUpload",{uploadInfoJson:j,isResume:a,mode:b})}function upload(a,b){var c,d,e,f,g,h,i;if(controlId=a,uploadObj=b,b.uploadedSize=0,b.uploadedPercent=0,b.fileGroup)for(c=b.fileGroup,i=0,e=0,f=c.length;e<f;e++)for(d=c[e],h=0,g=d.length;h<g;h++){if(b.uploadCompleted)return;getFileInfo(a,b,i,d[h])}else for(d=b.files,e=0,f=d.length;e<f;e++){if(b.uploadCompleted)return;getFileInfo(a,b,e,d[e])}}function getFileInfo(a,b,c,d){var e,f,g,h,i;g={_action:"getFileInfo",_innorix:"MultiSessionUpload",_product:"DS",_orig_filename:encodeURIComponent(d.name),_unique_filename:d.id,_filesize:d.size,_folder:"",_clientpath:"",_compressed:0};for(h in b.postData)g[h]=encodeURIComponent(b.postData[h]);for(h in d.postData)g[h]=encodeURIComponent(d.postData[h]);e=getFormData(g),f=new XMLHttpRequest,f.open("POST",d.uploadUrl?d.uploadUrl:b.uploadUrl,!0);for(i in b.headers)f.setRequestHeader(i,b.headers[i]);f.onload=function(){var e,f,g,h,i,j;b.uploadCompleted||(e=this,f=e.status,200===f?(h=decodeURIComponent(e.responseText),g=h.match(/<file_savepath>(.*[\/\\\\])(.*?)<\/file_savepath>/),i=g[1],j=g[2],d.clientPath="C:/sendbox/"+d.name,d.compressFileName="",d.compressFileSize=0,d.customValue="",d.encryptFileSize="0",d.fileSize=d.size,d.folder="",d.index=c,d.origFileName=d.name,d.progress="done",d.saveFileName=j,d.savePath=i+j,d.sendByte=d.size,d.status=3004,uploadChunk(a,b,c,d,i,j,0)):(b.uploadCompleted=!0,postMsg("uploadError",{errorCode:f})))},f.onerror=function(a){b.uploadCompleted||(b.uploadCompleted=!0,postMsg("uploadError",{errorCode:this.status}))},f.send(e)}function uploadChunk(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p;h=2097151,i=d.size,j=g+h>i?i:g+h,n={_action:"attachFile",_innorix:"MultiSessionUpload",_product:"DS",_orig_filename:encodeURIComponent(d.name),_new_filename:encodeURIComponent(f),_clientpath:"",_serverpath:encodeURIComponent(e+f),_unique_filename:d.id+".irx",_unique_filepath:encodeURIComponent(e+d.id+".irx"),_compressed:0,_filesize:i,_folder:"",_index:c,_start_offset:g,_end_offset:j,_encrypt:0,_empty_folder:0};for(o in b.postData)n[o]=encodeURIComponent(b.postData[o]);for(o in d.postData)n[o]=encodeURIComponent(d.postData[o]);n._file=d.originalInfo.slice(g,j),k=getFormData(n),l=new XMLHttpRequest,l.open("POST",d.uploadUrl?d.uploadUrl:b.uploadUrl,!0);for(p in b.headers)l.setRequestHeader(p,b.headers[p]);l.onload=function(){var h,k;b.uploadCompleted||(h=this,k=h.status,200===k?(m=j-g,b.uploadedSize+=m,handleUploadPercent(b),j<i?uploadChunk(a,b,c,d,e,f,j):uploadCompleted(b,d,e,f)):(b.uploadCompleted=!0,postMsg("uploadError",{errorCode:k})))},l.onerror=function(){b.uploadCompleted||(b.uploadCompleted=!0,postMsg("uploadError",{errorCode:this.status}))},l.send(k)}function handleUploadPercent(a){var b,c;b=a.uploadedPercent,c=Math.floor(100*a.uploadedSize/a.upFilesSize),c>b&&(a.uploadedPercent=c,postMsg("uploadUpdate",{upFilesSize:a.upFilesSize,uploadedSize:a.uploadedSize,uploadedPercent:c}))}function uploadCompleted(a,b,c,d){var e,f,g,h,i;g={_action:"attachFileCompleted",_innorix:"MultiSessionUpload",_product:"DS",_filepath:encodeURIComponent(c+d),_unique_filename:b.id+".irx",_unique_filepath:encodeURIComponent(c+b.id+".irx"),_filesize:b.size,_compressed:0,_compress_crc32:0,_compressed_size:0,_uncompressed_size:0,_check_integrity:0,_compress_upload_type:0,_integrity_crc32:"",_integrity_md5:"",_merging:0,_orig_filename:encodeURIComponent(b.name),_new_filename:encodeURIComponent(d),_encrypt:0};for(h in a.postData)g[h]=encodeURIComponent(a.postData[h]);for(h in b.postData)g[h]=encodeURIComponent(b.postData[h]);e=getFormData(g),f=new XMLHttpRequest,f.open("POST",b.uploadUrl?b.uploadUrl:a.uploadUrl,!0);for(i in a.headers)f.setRequestHeader(i,a.headers[i]);f.onload=function(){var b,c,d,e,f;if(!a.uploadCompleted)if(b=this,c=b.status,200===c){if(a.uploadedSize>=a.upFilesSize){if(a.uploadCompleted=!0,a.fileGroup)for(d=[],e=0,f=a.fileGroup.length;e<f;e++)d=d.concat(a.fileGroup[e]);else d=a.files;postMsg("uploadComplete",{uploadFileArray:d})}}else a.uploadCompleted=!0,postMsg("uploadError",{errorCode:c})},f.onerror=function(){a.uploadCompleted||(a.uploadCompleted=!0,postMsg("uploadError",{errorCode:this.status}))},f.send(e)}function uploadCancel(){uploadObj.uploadCompleted=!0}var controlId,fileInfo,addedFiles,errorFiles,uploadObj;formDataPolyfill(self),self.onmessage=function(a){var b,c,d;switch(b=a.data,c=b.type,d=b.value,c){case"createFileInfo":createFileInfo(b.controlId);break;case"refreshUi":refreshUi();break;case"addFile":addFile(d.originalFileInfos,d.controlProperty);break;case"removeAllFiles":removeAllFiles();break;case"prepareUpload":prepareUpload(d.isResume,d.mode);break;case"upload":upload(b.controlId,d);break;case"uploadCancel":uploadCancel()}};